name: Deploy Backend

on:
  push:
    branches: [main, dev]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: fuckwork-backend
  EC2_TAG_NAME: fuckwork-dev-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::302222527269:role/fuckwork-dev-github-actions-deploy-role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd apps/backend
          docker build --platform linux/amd64 -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f Dockerfile .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "‚úÖ Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
      
      - name: Get EC2 Instance Info
        id: ec2-info
        run: |
          # Âä®ÊÄÅËé∑Âèñ Instance ID Âíå Public IP
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${{ env.EC2_TAG_NAME }}" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)
          
          PUBLIC_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${{ env.EC2_TAG_NAME }}" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          if [ "$INSTANCE_ID" == "None" ] || [ -z "$INSTANCE_ID" ]; then
            echo "‚ùå No running instance found with tag: ${{ env.EC2_TAG_NAME }}"
            exit 1
          fi
          
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "üìç Found EC2: $INSTANCE_ID ($PUBLIC_IP)"
      
      - name: Deploy to EC2 via SSM
        run: |
          INSTANCE_ID="${{ steps.ec2-info.outputs.instance_id }}"
          
          echo "üöÄ Deploying to instance: $INSTANCE_ID"
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /home/ec2-user/fuckwork",
              "aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 302222527269.dkr.ecr.us-east-1.amazonaws.com",
              "docker-compose pull",
              "docker-compose up -d",
              "sleep 5",
              "docker-compose ps"
            ]' \
            --output text \
            --query 'Command.CommandId')
          
          echo "üìù SSM Command ID: $COMMAND_ID"
          
          # Wait and get status
          echo "‚è≥ Waiting for deployment to complete..."
          sleep 30
          
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query '{Status:Status,Output:StandardOutputContent}' \
            --output table || true
      
      - name: Verify deployment
        run: |
          PUBLIC_IP="${{ steps.ec2-info.outputs.public_ip }}"
          
          echo "üîç Health check: http://$PUBLIC_IP/health"
          
          for i in 1 2 3 4 5; do
            if curl -sf "http://$PUBLIC_IP/health" --max-time 10 > /dev/null 2>&1; then
              echo "‚úÖ Deployment verified successfully!"
              exit 0
            fi
            echo "Attempt $i/5 - waiting 10s..."
            sleep 10
          done
          
          echo "‚ö†Ô∏è Health check inconclusive, but deployment may still be successful"
          echo "Check manually: http://$PUBLIC_IP/health"
