name: CI JobSpy

on:
  pull_request:
    branches: [main, dev]
    paths:
      - 'apps/backend/src/fuckwork/services/collection/**'
      - 'apps/backend/Dockerfile.jobspy'
      - '.github/workflows/ci-jobspy.yml'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          cd apps/backend
          echo "üì¶ Installing dependencies..."
          pip install -r requirements/dev.txt
          echo "‚úÖ Dependencies installed"
      
      - name: Check import sorting (isort)
        run: |
          cd apps/backend
          echo "üîç Checking import sorting with isort..."
          isort --check-only --diff src/fuckwork/services/collection/
          echo "‚úÖ Import sorting OK"
      
      - name: Check code formatting (black)
        run: |
          cd apps/backend
          echo "üîç Checking code formatting with black..."
          black --check --diff src/fuckwork/services/collection/
          echo "‚úÖ Code formatting OK"

      - name: Lint with flake8
        run: |
          cd apps/backend
          echo "üîç Running flake8 linter..."
          flake8 src/fuckwork/services/collection/ \
            --max-line-length=100 \
            --exclude=__pycache__ \
            --statistics \
            --count
          echo "‚úÖ Flake8 passed"
      
      - name: Verify imports work
        run: |
          cd apps/backend
          echo "üîç Verifying collection module imports..."
          python -c "
          import sys
          sys.path.insert(0, 'src')
          
          from fuckwork.services.collection.jobspy_collector import JobSpyCollector
          print('  ‚úì JobSpyCollector imports OK')
          
          from fuckwork.services.collection.batch_collector import BatchCollector
          print('  ‚úì BatchCollector imports OK')
          
          from fuckwork.services.collection.search_config import SEARCH_QUERIES, PRESET_HOURLY
          print('  ‚úì Search config imports OK')
          
          print('‚úÖ All collection imports verified')
          "
      
      - name: Validate Dockerfile
        run: |
          cd apps/backend
          echo "üîç Validating Dockerfile.jobspy..."
          if [ -f "Dockerfile.jobspy" ]; then
            # Basic syntax check
            head -20 Dockerfile.jobspy
            echo "‚úÖ Dockerfile.jobspy exists and readable"
          else
            echo "‚ùå Dockerfile.jobspy not found!"
            exit 1
          fi
      
      - name: CI Summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "üìã CI JobSpy Summary"
          echo "========================================"
          echo "‚úÖ Completed all checks"
